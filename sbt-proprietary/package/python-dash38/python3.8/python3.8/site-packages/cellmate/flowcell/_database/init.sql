-- name: create-tables#
CREATE TABLE IF NOT EXISTS site (name TEXT PRIMARY KEY NOT NULL);

CREATE TABLE IF NOT EXISTS variable (
    name TEXT PRIMARY KEY NOT NULL,
    value BLOB NOT NULL
);

CREATE TABLE IF NOT EXISTS site_variable (
    site TEXT NOT NULL REFERENCES site,
    name TEXT NOT NULL,
    value BLOB NOT NULL,
    PRIMARY KEY (site, name)
);

CREATE TABLE IF NOT EXISTS log (
    id INTEGER PRIMARY KEY NOT NULL,
    started_on DATETIME NOT NULL,
    stopped_on DATETIME NOT NULL,
    program TEXT NOT NULL,
    device_id TEXT NOT NULL,
    durability_cost INTEGER NOT NULL,
    state INTEGER NOT NULL,
    data JSON,
    CONSTRAINT ck_log_started_on_is_int CHECK (typeof(started_on) = 'integer'),
    CONSTRAINT ck_log_stopped_on_is_int CHECK (typeof(stopped_on) = 'integer'),
    CONSTRAINT ck_log_stopped_geq_started CHECK (stopped_on >= started_on),
    CONSTRAINT ck_durability_cost_geq_0 CHECK (durability_cost >= 0)
);

-- name: create-triggers#
-- Inspiration from https://stackoverflow.com/a/42174064/554283
CREATE TRIGGER IF NOT EXISTS nonoverlapping_log_entries BEFORE
INSERT
    ON log BEGIN
SELECT
    RAISE(
        FAIL,
        "Log entry overlaps with a previous entry."
    )
FROM
    log
WHERE
    NEW.started_on < stopped_on;

END;