import logging
from datetime import timedelta
from contextlib import AbstractContextManager, contextmanager


_LOGGER = logging.getLogger(__name__)


class ProgramSection(AbstractContextManager):
	def __init__(self,
	             *,
	             log,
	             name=None,
	             expected_duration=None,
				 hide_exact_duration=False):
		self._log = log
		self._name = name
		self._expected_duration = timedelta(seconds=expected_duration)
		self._hide_exact_duration = hide_exact_duration
		# We need to keep a reference to the duration context manager
		# (even though we don't use it directly) so that it won't be
		# garbage-collected right away. We need to hold the duration
		# reference for the lifetime of the PerfCounter.
		self._duration = self._log.duration(expected=expected_duration)
		self._dt = None

	@property
	def name(self) -> str:
		return self._name

	def json(self) -> dict:
		result = {
			'name': self._name,
			'startedAt': self._dt.started_at.timestamp(),
			'duration': {
				'elapsed': self._dt.elapsed.total_seconds(),
				'expected': self._expected_duration.total_seconds(),
				'hideExactNumber': self._hide_exact_duration,
			},
			'done': self._dt.done,
		}
		if self._dt.done:
			result['doneAt'] = self._dt.done_at.timestamp()
		return result

	def __enter__(self):
		self._dt = self._duration.__enter__()
		return self

	def __exit__(self, *args, **kwargs):
		self._duration.__exit__(*args, **kwargs)


class ProgramSections:
	def __init__(self, log):
		self._log = log
		self._all = []
		self._current = None

	@contextmanager
	def section(self, *args, **kwargs):
		if self._current is not None:
			raise RuntimeError("Sections are not re-entrant. You must exit the current section before entering a new one.")
		try:
			with ProgramSection(*args, log=self._log, **kwargs) as section:
				self._all.append(section)
				self._current = section
				yield section
		finally:
			self._current = None

	@property
	def current(self):
		return self._current

	def reset(self):
		self._all.clear()
		self._current = None
