import logging
from contextlib import contextmanager


_LOGGER = logging.getLogger(__name__)


@contextmanager
def stack_trace_dump_signal(dump_path):
	try:
		from signal import SIGUSR1
	except ImportError:
		_LOGGER.info('Unable to initialize stack trace dump handler.')
		return
	import faulthandler
	import os
	try:
		os.makedirs(os.path.dirname(dump_path), exist_ok=True)
		with open(dump_path, 'w') as f:
			faulthandler.register(SIGUSR1, file=f)
			yield
	finally:
		faulthandler.unregister(SIGUSR1)
